<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <h1>Quiz Results</h1>
        <div class="header-actions">
            <a href="{{ url_for('home') }}" class="home-btn">
                <i class="fas fa-home"></i>
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <div class="container">
        <div class="scoreboard">
            <div class="score-container">
                <div class="score">
                    Score: {{ score }}/{{ total }}
                    <span class="score-percentage">({{ "%.1f"|format(score/total * 100) }}%)</span>
                </div>
            </div>

            {% for i, answer in enumerate(user_answers) %}
            <div class="result-item {% if answer.user_answer == answer.correct_answer %}correct{% else %}incorrect{% endif %}">
                <h3>Question {{ i + 1 }}</h3>
                <p>{{ answer.question }}</p>
                <div class="options">
                    {% for option in answer.options %}
                    <div class="option {% if option == answer.correct_answer %}correct-answer{% elif option == answer.user_answer %}wrong-answer{% endif %}">
                        <span class="option-text">{{ option }}</span>
                        {% if option == answer.correct_answer %}
                        <span class="correct-label">Correct Answer</span>
                        {% elif option == answer.user_answer %}
                        <span class="user-label">Your Answer</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <button class="explanation-btn" onclick="getExplanation({{ i }})">
                    <i class="fas fa-lightbulb"></i> Get Explanation
                </button>
                <div class="explanation-container" id="explanation-{{ i }}">
                    <p>Loading explanation...</p>
                </div>
            </div>
            {% endfor %}

            <div class="action-buttons">
                <a href="{{ url_for('download_file', filename='results.pdf') }}" class="action-button">
                    <i class="fas fa-download"></i> Download Results PDF
                </a>
                <button class="action-button" onclick="generateNotes()">
                    <i class="fas fa-file-alt"></i> Download Short Notes
                </button>
                <a href="{{ url_for('home') }}" class="action-button">
                    <i class="fas fa-redo"></i> Take Another Quiz
                </a>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('.theme-toggle i');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
        }

        // Get explanation for a question
        function getExplanation(questionIndex) {
            const container = document.getElementById(`explanation-${questionIndex}`);
            const question = container.closest('.result-item').querySelector('p').textContent;
            const correctAnswer = container.closest('.result-item').querySelector('.correct-answer .option-text').textContent;
            
            container.classList.add('show');
            container.querySelector('p').textContent = 'Loading explanation...';

            fetch('/get_reasoning', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    correct_answer: correctAnswer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    container.querySelector('p').textContent = data.reasoning;
                } else {
                    container.querySelector('p').textContent = 'Failed to load explanation. Please try again.';
                }
            })
            .catch(error => {
                container.querySelector('p').textContent = 'Error loading explanation. Please try again.';
            });
        }

        // Generate study notes
        function generateNotes() {
            const button = document.querySelector('.action-button:nth-child(2)');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Notes...';
            button.disabled = true;

            fetch('/generate_notes', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = `/download/${data.notes_path}`;
                } else {
                    alert('Failed to generate notes. Please try again.');
                }
            })
            .catch(error => {
                alert('Error generating notes. Please try again.');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    </script>
</body>
</html>